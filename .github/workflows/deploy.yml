name: Deploy SnapQuote

on:
  push:
    branches: [ main ] # This will always auto-deploy to STAGING
  workflow_dispatch:
    # This manual trigger will be strictly for LIVE

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Build Frontend
        run: |
          cd client
          npm install
          npm run build

      - name: Deploy to Server via SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            # Determine environment: 
            # If triggered by a 'push' -> deploy to staging
            # If triggered manually -> deploy to live
            if [ "${{ github.event_name }}" == "push" ]; then
                ENV="staging"
                PORT="5001"
            else
                ENV="live"
                PORT="5000"
            fi
            
            TARGET_DIR="/var/www/snapquote/$ENV"
            REPO_URL="https://github.com/asgharh24/SnapQuote.git"
            
            echo "ðŸš€ STAGE: Starting deployment to $ENV environment..."
            
            # Ensure target directory exists and is a git repo
            if [ ! -d "$TARGET_DIR/.git" ]; then
                echo "Directory is not a git repo. Performing initial clone..."
                sudo mkdir -p $TARGET_DIR
                sudo chown -R $USER:$USER $TARGET_DIR
                rm -rf $TARGET_DIR/*
                git clone $REPO_URL $TARGET_DIR
            fi

            cd $TARGET_DIR
            git fetch --all
            git reset --hard origin/main
            
            # Setup Backend
            cd server
            npm install --production
            
            # Setup Frontend
            cd ../client
            npm install
            npm run build
            
            # Restart Application
            cd ../server
            # Load path for PM2 if necessary
            export PATH=$PATH:/usr/bin:/usr/local/bin
            pm2 delete "snapquote-$ENV" || true
            PORT=$PORT pm2 start index.js --name "snapquote-$ENV" --update-env
            
            echo "âœ… Deployment to $ENV complete!"
